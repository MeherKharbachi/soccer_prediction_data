# AUTOGENERATED! DO NOT EDIT! File to edit: ../../nbs/dataStrcuture/04_data_extractor.ipynb.

# %% auto 0
__all__ = ['STATS', 'COMPETITION_IDS', 'data_aggregator']

# %% ../../nbs/dataStrcuture/04_data_extractor.ipynb 3
import pandas as pd
from tqdm.auto import tqdm
from typing import List, Tuple
from ..config.mongo import mongo_init
from .fixture import * 
from .team_stats import *

# %% ../../nbs/dataStrcuture/04_data_extractor.ipynb 6
STATS = [
    "Ball possession in own half",
    "Ball possession in opp. half",
    "Challenges / won",
    "Challenges lost",
    "Challenge intensity index",
    "Passes accurate",
    "Accurate passes into the final third of the pitch",
    "Passes into the penalty box",
    "Diagonal passes",
    "Key passes",
    "Crosses accurate",
    "Crosses to the near post - % efficiency",
    "Crosses into the six-yard box - % efficiency",
    "Shots on target",
    "GK actions - Shots saved",
    "xG per shot",
    "Chance TOTAL",
    "Chances, % of conversion",
    "Attacking mentality index",
    "Dribbles successful",
    "Dribbles unsuccessful",
    "Successful tackles",
    "Unsuccessful tackles",
    "Interceptions / in opp. half",
    "Ball recoveries / in opp. half",
    "Fouls",
    "Lost balls / in own half",
    "Average distance to the goal at ball losses",
    "Average distance to the goal at ball recoveries",
]

COMPETITION_IDS = [
    1,    # Russia. Premier League
    9,    # Russia. FNL
    20,   # Spain. Primera Division
    24,   # Italy. Serie A
    28,   # Portugal. Liga NOS
    29,   # Netherlands. Eredivisie
    31,   # Germany. Bundesliga
    37,   # France. Ligue 1
    39,   # England. Premier League
    41,   # United States. MLS
    45,   # Belgium. Jupiler Pro League
    52,   # Sweden. Allsvenskan
    72,   # Germany. 2. Bundesliga
    76,   # England. League Two
    78,   # Switzerland. Super League
    80,   # Italy. Serie B
    86,   # Norway. Eliteserien
    93,   # Argentina. Primera Division
    95,   # Australia. A-League
    103,  # Scotland. Premier League
    105,  # England. Championship
    108,  # Mexico. Liga MX
    109,  # Spain. Segunda Division
    110,  # France. Ligue 2
    112,  # Morocco. GNF 1
    123,  # England. League One
    193,  # Algeria. Ligue 1
    213,  # Chile. Primera Division
    300,  # Scotland. Championship
    307,  # South Africa. PSL
    464,  # Germany. 3. Liga
    496,  # France. Championnat National
    792,  # Scotland. League One
    903,  # Scotland League Two
    936,  # England. National League North
]

# %% ../../nbs/dataStrcuture/04_data_extractor.ipynb 9
def data_aggregator(
    competition_ids: List[int] = COMPETITION_IDS,  # Competitions to extract.
    stats_attributes: List[str] = STATS, # Stats attributes to extract.
    limit: int = None,  # Number of rows to extract.
) -> Tuple:  # Mapped games (played games and future games).
    "Returns and aggregates games information from multiple Db collections."

    def _team_stats(
        game_id: int,  # Instat game identifier.
        team_id: int,  # Instat team identifier.
    ) -> pd.DataFrame:  # Team Stats
        "Returns stats of a given team in a given game."

        # Team features.
        team_feats = TeamStats.get_game_team_stats(
            game_id=game_id,
            team_id=team_id,
        )
        if team_feats is None:
            return pd.DataFrame(index=[0])

        # Team stats.
        team_stats = {
            stat.action_name.strip()
            .replace("- ", "")
            .replace(", ", "")
            .replace("/ ", "")
            .title()
            .replace(" ", ""): stat.value
            for stat in team_feats.stats
            if stat.action_name in stats_attributes
        }

        return pd.DataFrame(team_stats, index=[0])

    # Extract games.
    games = Fixture.get_games_by_competition(
        competition_ids=competition_ids, limit=limit
    )
    games = pd.DataFrame(games.as_pymongo())

    # Map results {HS: Home goals scored, AS: Away goals scored}.
    games[["HS", "AS"]] = games["fullTimeScore"].apply(
        lambda lst: pd.Series(
            [
                (lst[0] if len(lst) > 0 else -1),
                (lst[1] if len(lst) > 0 else -1),
            ]
        )
        if isinstance(lst, list)
        else pd.Series([-1, -1])
    )

    # Filter Data.
    games = games[
        [
            "gameId",
            "gameDate",
            "seasonName",
            "competitionName",
            "homeTeamId",
            "homeTeamName",
            "awayTeamId",
            "awayTeamName",
            "HS",
            "AS",
        ]
    ]

    # Filter df.
    future_games = games[games.HS == -1].copy()
    played_games = games[games.HS != -1].copy()

    if played_games.empty:
        return None, future_games

    # Compute other features.
    def _one_game(row):
        ht_stats = _team_stats(
            game_id=row["gameId"], team_id=row["homeTeamId"]
        ).add_prefix("homeTeam")

        at_stats = _team_stats(
            game_id=row["gameId"], team_id=row["awayTeamId"]
        ).add_prefix("awayTeam")

        res = pd.concat([ht_stats, at_stats], axis=1)
        res.loc[:, "gameId"] = row.gameId

        return res

    played_games = played_games.merge(
        pd.concat(
            [
                _one_game(row)
                for _, row in tqdm(played_games.iterrows(), total=played_games.shape[0])
            ]
        ).reset_index(drop=True),
        on="gameId",
        how="left",
    )

    return played_games, future_games
